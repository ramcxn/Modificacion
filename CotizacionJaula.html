<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cotización - Talleres Barrera</title>

  <!-- Iconos y estilos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link rel="stylesheet" href="https://ramcxn.github.io/Modificacion/cotizacion.css?v=3"/>

  <!-- Precarga html2pdf (bundle con html2canvas + jsPDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>

  <style>
    /* Evitar cortes en impresión/PDF */
    @media print {
      body { font-size: 10px; }
      .section, .header { padding: 10px; margin-bottom: 5px; }
      .actions-bar, .vendor-only { display: none !important; }
      .info-table td, .cost-table th, .cost-table td { padding: 3px; }
      .logo { width: 100px !important; }
    }
    .info-table, .cost-table, .bank-table,
    .header, .footer-logo-container, .section, .image-container, .reference-image {
      page-break-inside: avoid;
      break-inside: avoid;
    }

    /* Barra de acciones (no sale en PDF/impresión) */
    .actions-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .action-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 0;
      background: #0f766e;
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }
    .action-button.secondary { background: #1f2937; }

    /* Controles solo vendedor (no salen en PDF/impresión) */
    .vendor-only{background:#f9fafb;border:1px dashed #d1d5db;border-radius:8px;padding:10px;margin:10px 0}
    .vendor-only .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .vendor-only label{font-weight:600}
    .vendor-only input,.vendor-only select{padding:6px 8px;border:1px solid #d1d5db;border-radius:6px}
    .vendor-only button{border:0;background:#0f766e;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
    .vendor-only button.secondary{background:#6b7280}
  </style>
</head>
<body>
  <div class="container" id="cotizacion-root">
    <div class="actions-bar no-pdf">
      <button class="action-button" onclick="window.print()">
        <i class="fas fa-print"></i> Imprimir
      </button>
      <button class="action-button" onclick="downloadPDF()">
        <i class="fas fa-file-pdf"></i> Descargar PDF
      </button>
      <button class="action-button secondary" onclick="sharePDFByEmail()">
        <i class="fas fa-paper-plane"></i> Enviar PDF por correo
      </button>
    </div>

    <div class="header">
      <div class="header-info">
        <h1>COTIZACIÓN</h1>
        <h2>TALLERES BARRERA S.A. DE C.V.</h2>
        <p><strong>Dirección:</strong> Industria Automotriz #126, Col. Parque Industrial, CP 67735, Linares N.L. México</p>
        <p><strong>Teléfono:</strong> <span id="telefonoContacto"></span></p>
        <p><strong>Correo:</strong> <span id="correoContacto"></span></p>
        <p><strong>RFC:</strong> TBA7504018B4</p>
      </div>
      <img id="logoPrincipal"
           src="https://www.appsheet.com:443/fsimage.png?appid=15ab7ef8-4923-40f5-80ca-3607e9850805&datasource=google&filename=DocId%3D1ON0AOw6aLouPB4hLD4HSPHQrMyYHFX5x&signature=47171ea295d0c06dc250337a646296a67b31c22191c59f9869bf63a365b8ae49&tableprovider=google&userid=1254688"
           alt="Logo de Talleres Barrera"
           class="logo"
           onerror="(function(img){try{const p=new URLSearchParams(location.search);const alt=p.get('logo');if(alt){img.src=alt;}}catch(e){}})(this)"/>
    </div>

    <p>Por medio de la presente, <strong>TALLERES BARRERA S.A. DE C.V.</strong> agradece su interés en nuestros productos. A continuación, se presenta la cotización detallada para la fabricación de su remolque, incluyendo especificaciones, costos y términos de pago.</p>

    <div class="section">
      <h3 class="section-title">Información del Cliente y General</h3>
      <table class="info-table">
        <tr><td>Fecha de Cotización:</td><td><span id="fechaCotizacion"></span></td></tr>
        <tr><td>Cliente:</td><td><span id="cliente"></span></td></tr>
        <tr><td>Dirección del Cliente:</td><td><span id="direccionCliente"></span></td></tr>
        <tr><td>RFC del Cliente:</td><td><span id="rfcCliente"></span></td></tr>
        <tr><td>Tipo de Unidad:</td><td><span id="tipoUnidad"></span></td></tr>
        <tr><td>Realizado por (Vendedor):</td><td><span id="realizadoPor"></span></td></tr>
      </table>
    </div>

    <div class="section">
      <h3 class="section-title">Especificaciones Generales</h3>
      <table class="info-table">
        <tr><td>Color Primario:</td><td><span id="colorPrimario"></span></td></tr>
        <tr><td>Color Secundario:</td><td><span id="colorSecundario"></span></td></tr>
        <tr><td>Suspensión:</td><td><span id="suspension"></span> (<span id="cantSuspensiones"></span> piezas)</td></tr>
        <tr><td>Retráctil de Eje:</td><td><span id="retractilEje"></span></td></tr>
        <tr><td>Ejes:</td><td><span id="ejes"></span></td></tr>
        <tr><td>Distancia entre Ejes:</td><td><span id="distanciaEjes"></span></td></tr>
        <tr><td>Personalización de Viga:</td><td><span id="personalizacionViga"></span></td></tr>
        <tr><td>Faldón:</td><td><span id="faldon"></span></td></tr>
        <tr><td>Perno Rey:</td><td><span id="pernoRey"></span></td></tr>
        <tr><td>Portallantas:</td><td><span id="portallantas"></span></td></tr>
      </table>
    </div>

    <div class="section">
      <h3 class="section-title">Carrocería y Estructura</h3>
      <table class="info-table">
        <tr><td>Dimensiones:</td><td><span id="dimensiones"></span></td></tr>
        <tr><td>Tipo de Redila:</td><td><span id="tipoRedila"></span></td></tr>
        <tr><td>Secciones:</td><td><span id="secciones"></span></td></tr>
        <tr><td>Puertas Laterales:</td><td><span id="puertasLaterales"></span></td></tr>
        <tr><td>Compuerta al Piso:</td><td><span id="compAlPiso"></span></td></tr>
        <tr><td>Compuerta Trasera:</td><td><span id="compAtras"></span></td></tr>
        <tr><td>Tipo de Arco:</td><td><span id="tipoArco"></span></td></tr>
        <tr><td>Piso de Madera:</td><td><span id="pisoMadera"></span></td></tr>
        <tr><td>Piso Laminado:</td><td><span id="pisoLaminado"></span></td></tr>
        <tr><td>Caballete:</td><td><span id="caballete"></span></td></tr>
        <tr><td>Tubos Interiores:</td><td><span id="tubosInteriores"></span></td></tr>
        <tr><td>Barrote Lateral:</td><td><span id="barroteLateral"></span></td></tr>
        <tr><td>Compuerta a los Lados:</td><td><span id="compuertaLados"></span></td></tr>
        <tr><td>Cerrojo de Puertas Traseras:</td><td><span id="cerrojoPuertas"></span></td></tr>
        <tr><td>Sistema de Lona:</td><td><span id="sistemaLona"></span></td></tr>
        <tr><td>Luz de Placa:</td><td><span id="luzPlaca"></span></td></tr>
      </table>
    </div>

    <div class="section">
      <h3 class="section-title">Accesorios</h3>
      <table class="info-table">
        <tr><td>Rines:</td><td><span id="rines"></span> (<span id="cantRines"></span> piezas)</td></tr>
        <tr><td>Llantas:</td><td><span id="llantas"></span> (<span id="cantLlantas"></span> piezas)</td></tr>
        <tr><td>Frenos:</td><td><span id="frenos"></span></td></tr>
        <tr><td>Juego de Patines:</td><td><span id="juegoPatines"></span> (<span id="cantPatines"></span> piezas)</td></tr>
        <tr><td>Caja de Herramientas:</td><td><span id="cajaHerramientas"></span></td></tr>
        <tr><td>Lodera Delantera:</td><td><span id="loderaDelantera"></span></td></tr>
        <tr><td>Lodera Trasera:</td><td><span id="loderaTrasera"></span></td></tr>
        <tr><td>Manivelas de Patín:</td><td><span id="manivelasPatin"></span></td></tr>
        <tr><td>Direccionales:</td><td><span id="direccionales"></span></td></tr>
        <tr><td>Plafones:</td><td><span id="plafones"></span></td></tr>
      </table>
    </div>

    <div class="section">
      <h3 class="section-title">Imágenes de Referencia</h3>
      <div class="image-container" id="imagenes-container"></div>
    </div>

    <!-- Ajuste de precio manual (no se imprime ni sale en PDF) -->
    <div class="section vendor-only no-pdf">
      <h3 class="section-title">Ajuste de precio manual (solo vendedor)</h3>
      <div class="row">
        <label for="ajusteTipo">Tipo:</label>
        <select id="ajusteTipo">
          <option value="descuento">Descuento (-)</option>
          <option value="incremento">Incremento (+)</option>
        </select>
        <label for="ajusteModo">Modo:</label>
        <select id="ajusteModo">
          <option value="monto">Monto</option>
          <option value="porcentaje">Porcentaje</option>
        </select>
        <label for="ajusteValor">Valor:</label>
        <input id="ajusteValor" type="number" step="0.01" placeholder="0" style="width:120px" />
        <button type="button" id="btnAplicarAjuste"><i class="fas fa-check"></i> Aplicar</button>
        <button type="button" class="secondary" id="btnQuitarAjuste"><i class="fas fa-undo"></i> Quitar</button>
      </div>
      <small>Este ajuste no se guarda en AppSheet; solo modifica esta vista antes de imprimir, enviar o descargar.</small>
    </div>

    <div class="section">
      <h3 class="section-title">Resumen de Costos y Términos de Pago</h3>
      <table class="cost-table">
        <thead>
          <tr><th>Concepto</th><th>Monto</th></tr>
        </thead>
        <tbody>
          <tr><td>Costo Total de la Unidad:</td><td><span id="costoTotal"></span></td></tr>
          <!-- Fila visible solo si hay ajuste -->
          <tr id="rowAjuste" style="display:none"><td>Ajuste de precio manual:</td><td><span id="ajusteMonto"></span></td></tr>
          <tr><td>Depósito para Inicio de Fabricación (50%):</td><td><span id="deposito"></span></td></tr>
          <tr><td>Saldo a Liquidar a la Entrega (50%):</td><td><span id="saldo"></span></td></tr>
          <tr class="total-row"><td>TOTAL:</td><td><strong><span id="totalFinal"></span></strong></td></tr>
        </tbody>
      </table>

      <div class="bank-info">
        <p><strong>Datos Bancarios para Depósito:</strong></p>
        <p><strong>Titular:</strong> TALLERES BARRERA S.A. DE C.V.</p>
        <table class="bank-table">
          <thead>
            <tr><th>Banco</th><th>Sucursal</th><th>Cuenta</th><th>CLABE</th></tr>
          </thead>
          <tbody>
            <tr><td>SANTANDER</td><td>3945</td><td>65500883468</td><td>014 595 65500883468 7</td></tr>
            <tr><td>BBVA</td><td>1729</td><td>00450461113</td><td>012 580 00450461113 7</td></tr>
            <tr><td>CITIBANAMEX</td><td>0796</td><td>07966989054</td><td>002 595 07966989054 8</td></tr>
            <tr><td>BANORTE</td><td>060</td><td>00060251843</td><td>072 595 00060251843 3</td></tr>
          </tbody>
        </table>
        <p>Favor de enviar su notificación de depósito a los siguientes correos: <strong>contabilidad@talleresbarrera.com</strong> y <strong>barrera@talleresbarrera.com</strong>.</p>
      </div>

      <p><strong>Consideraciones:</strong></p>
      <ul class="notes-list">
        <li>El depósito inicial no es reembolsable.</li>
        <li>El precio final puede ajustarse en caso de que se soliciten modificaciones adicionales no contempladas en esta cotización.</li>
        <li>El tiempo de entrega estimado es de 6 a 8 semanas, a partir de la confirmación del depósito inicial.</li>
        <li>A partir de la fecha de entrega emitida, se tendrá un tiempo de almacén de 15 días naturales. A partir de este tiempo, se generará un costo por almacenamiento de la unidad de $1,000 pesos por semana.</li>
      </ul>
    </div>

    <div class="section">
      <h3 class="section-title">Aprobación del Cliente</h3>
      <p>Con la firma de este documento, usted confirma que ha revisado y aprobado las especificaciones y los costos detallados en esta cotización. Esta firma autoriza a TALLERES BARRERA S.A. DE C.V. a iniciar el proceso de fabricación de la unidad.</p>
      <div class="firma-section">
        <div class="firma-line"></div>
        <p>Firma de Aprobación</p>
      </div>
    </div>

    <div class="footer-logo-container">
      <img id="logoISO"
           src="https://raw.githubusercontent.com/ramcxn/Modificacion/main/CER%20COMPANY%20-%20ISO%209001.png"
           alt="Empresa Certificada ISO 9001:2015"
           class="iso-logo">
    </div>

  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const appName = "NewApp-1254688";
      const tableName = "Modificaciones";

      // Permite override de logo via ?logo=...
      try {
        const altLogo = urlParams.get('logo');
        if (altLogo) document.getElementById('logoPrincipal').src = altLogo;
      } catch(e) {}

      // getParam robusto
      const getParam = (name, fallback = 'Especificación no proporcionada') => {
        const raw = urlParams.get(name);
        if (raw === null || raw === undefined) return fallback;
        const normalized = String(raw).replace(/\+/g, ' ');
        try {
          const val = decodeURIComponent(normalized);
          if (val.trim() === '' || val.toLowerCase() === 'null' || val.toLowerCase() === 'undefined') return fallback;
          return val;
        } catch {
          return normalized || fallback;
        }
      };

      // Convierte número desde texto con comas/símbolos
      const parseNumber = (s) => {
        if (s == null) return 0;
        const clean = String(s).replace(/[^\d.,-]/g,'').replace(/,/g,''); // quita símbolos y comas
        const n = parseFloat(clean);
        return isNaN(n) ? 0 : n;
        // Si AppSheet a veces manda formateado con $ o comas, igual lo capturamos.
      };

      const getAppSheetImageUrl = (fileName) => {
        if (!fileName) return '';
        return `https://www.appsheet.com/template/gettablefileurl?appName=${appName}&tableName=${tableName}&fileName=${encodeURIComponent(fileName)}`;
      };

      const formatCurrency = (value) => {
        const n = typeof value === 'number' ? value : parseNumber(value);
        return `$${n.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} MXN`;
      };

      // ====== Poblar datos ======
      document.getElementById('fechaCotizacion').innerText = new Date().toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' });
      document.getElementById('telefonoContacto').innerText = getParam('telefono_contacto');
      document.getElementById('correoContacto').innerText = getParam('correo_contacto');
      document.getElementById('cliente').innerText = getParam('cliente');
      document.getElementById('direccionCliente').innerText = getParam('direccion');
      document.getElementById('rfcCliente').innerText = getParam('rfc');
      document.getElementById('tipoUnidad').innerText = getParam('tipo_de_unidad');
      document.getElementById('realizadoPor').innerText = getParam('realizado_por');
      document.getElementById('dimensiones').innerText = getParam('dimensiones');

      document.getElementById('colorPrimario').innerText = getParam('color');
      document.getElementById('colorSecundario').innerText = getParam('color_2');
      document.getElementById('suspension').innerText = getParam('suspension');
      document.getElementById('cantSuspensiones').innerText = getParam('cantidad_de_suspensiones');
      document.getElementById('retractilEje').innerText = getParam('retractil_eje');
      document.getElementById('ejes').innerText = getParam('ejes');
      document.getElementById('distanciaEjes').innerText = getParam('distancia_de_ejes');
      document.getElementById('personalizacionViga').innerText = getParam('personalizacion_de_viga');
      document.getElementById('faldon').innerText = getParam('faldon');
      document.getElementById('pernoRey').innerText = getParam('perno_rey');
      document.getElementById('portallantas').innerText = getParam('portallantas');

      document.getElementById('tipoRedila').innerText = getParam('tipo_de_redila');
      document.getElementById('secciones').innerText = getParam('secciones');
      document.getElementById('puertasLaterales').innerText = getParam('puertas_laterales');
      document.getElementById('compAlPiso').innerText = getParam('comp_al_piso');
      document.getElementById('compAtras').innerText = getParam('comp_atras');
      document.getElementById('tipoArco').innerText = getParam('tipo_de_arco');
      document.getElementById('pisoMadera').innerText = getParam('piso_de_madera');
      document.getElementById('pisoLaminado').innerText = getParam('piso_laminado');
      document.getElementById('caballete').innerText = getParam('caballete');
      document.getElementById('tubosInteriores').innerText = getParam('tubos_interiores');
      document.getElementById('barroteLateral').innerText = getParam('barrote_lateral');
      document.getElementById('compuertaLados').innerText = getParam('compuerta_a_los_lados');
      document.getElementById('cerrojoPuertas').innerText = getParam('cerrojo_de_puertas_traseras');
      document.getElementById('sistemaLona').innerText = getParam('sistema_de_lona');
      document.getElementById('luzPlaca').innerText = getParam('luz_placa');

      document.getElementById('rines').innerText = getParam('rines');
      document.getElementById('cantRines').innerText = getParam('cantidad_de_rines');
      document.getElementById('llantas').innerText = getParam('llantas_70');
      document.getElementById('cantLlantas').innerText = getParam('cantidad_de_llantas');
      document.getElementById('frenos').innerText = getParam('frenos');
      document.getElementById('juegoPatines').innerText = getParam('juego_de_patines');
      document.getElementById('cantPatines').innerText = getParam('cantidad_de_patines');
      document.getElementById('cajaHerramientas').innerText = getParam('caja_de_herramientas');
      document.getElementById('loderaDelantera').innerText = getParam('lodera_delantera');
      document.getElementById('loderaTrasera').innerText = getParam('lodera_trasera');
      document.getElementById('manivelasPatin').innerText = getParam('manivelas_de_patin');
      document.getElementById('direccionales').innerText = getParam('direccionales');
      document.getElementById('plafones').innerText = getParam('plafones');

      document.getElementById('observacionesPintura').innerText = getParam('observaciones_de_pintura');
      document.getElementById('observacionesGenerales').innerText = getParam('observaciones');

      // ====== Costos con ajuste ======
      let baseCosto = parseNumber(getParam('Costo_de_la_Unidad', '0'));
      let ajusteActual = 0; // (+) incremento, (-) descuento

      const renderTotales = () => {
        const total = Math.max(0, baseCosto + ajusteActual);
        const deposito = total * 0.50;
        const saldo = total - deposito;

        document.getElementById('costoTotal').innerText = formatCurrency(baseCosto);
        if (Math.abs(ajusteActual) > 0) {
          document.getElementById('rowAjuste').style.display = '';
          const signo = ajusteActual >= 0 ? '' : '-';
          document.getElementById('ajusteMonto').innerText = `${signo}${formatCurrency(Math.abs(ajusteActual))}`;
        } else {
          document.getElementById('rowAjuste').style.display = 'none';
        }
        document.getElementById('deposito').innerText = formatCurrency(deposito);
        document.getElementById('saldo').innerText = formatCurrency(saldo);
        document.getElementById('totalFinal').innerText = formatCurrency(total);
      };
      renderTotales();

      // Controles de ajuste (solo vendedor)
      function aplicarAjusteDesdeUI(){
        const tipo = (document.getElementById('ajusteTipo')?.value || 'descuento');
        const modo = (document.getElementById('ajusteModo')?.value || 'monto');
        const val = parseNumber(document.getElementById('ajusteValor')?.value || '0');

        let monto = 0;
        if (!isNaN(val) && val > 0) {
          monto = (modo === 'porcentaje') ? (baseCosto * (val/100)) : val;
          if (tipo === 'descuento') monto = -monto;
        }
        ajusteActual = monto;
        renderTotales();
      }
      document.getElementById('btnAplicarAjuste')?.addEventListener('click', aplicarAjusteDesdeUI);
      document.getElementById('btnQuitarAjuste')?.addEventListener('click', ()=>{
        document.getElementById('ajusteValor').value = '';
        ajusteActual = 0;
        renderTotales();
      });
      document.getElementById('ajusteValor')?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ aplicarAjusteDesdeUI(); }});

      // ====== Imágenes ======
      const imagenesContainer = document.getElementById('imagenes-container');
      const imagenParams = ['imagen_de_referencia','imagen_de_referencia_81','imagen_de_referencia_82','imagen_de_referencia_83','imagen_de_referencia_84','imagen_de_referencia_85'];
      let hasImages = false;
      imagenParams.forEach(paramName => {
        const fileName = getParam(paramName, '');
        if (fileName && fileName !== 'Especificación no proporcionada') {
          const img = document.createElement('img');
          img.src = getAppSheetImageUrl(fileName);
          img.alt = 'Imagen de referencia';
          img.className = 'reference-image';
          imagenesContainer.appendChild(img);
          hasImages = true;
        }
      });
      if (!hasImages) {
        imagenesContainer.innerHTML = '<p>No se han proporcionado imágenes de referencia.</p>';
      }

      // ====== Helpers PDF ======
      const waitForImages = (root, timeoutMs = 6000) => {
        const imgs = Array.from(root.querySelectorAll('img'));
        if (!imgs.length) return Promise.resolve();
        return Promise.race([
          Promise.all(imgs.map(img => new Promise(res => {
            if (img.complete) return res();
            const done = () => { img.removeEventListener('load', done); img.removeEventListener('error', done); res(); };
            img.addEventListener('load', done); img.addEventListener('error', done);
          })) ),
          new Promise(res => setTimeout(res, timeoutMs))
        ]);
      };

      const todayISO = new Date().toISOString().slice(0,10);
      const safe = (s) => (s||'').toString().replace(/[^a-z0-9-_]+/gi,'_').slice(0,60);
      const defaultFilename = `Cotizacion_${safe(getParam('cliente','Cliente'))}_${todayISO}.pdf`;
      window.__pdfFilename = defaultFilename;

      const buildPrintableClone = () => {
        const src = document.getElementById('cotizacion-root');
        const clone = src.cloneNode(true);
        // Remover elementos de UI que no van al PDF
        clone.querySelectorAll('.no-pdf, .vendor-only').forEach(n=> n.remove());
        // Envolver en contenedor blanco
        const wrap = document.createElement('div');
        wrap.style.background = '#ffffff';
        wrap.appendChild(clone);
        return wrap;
      };

      const html2pdfOpts = {
        margin: [10,10,10,10],
        filename: window.__pdfFilename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, allowTaint: true, letterRendering: true },
        jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all','css','legacy'] }
      };

      // -> versión compatible para obtener BLOB
      window.generatePdfBlob = async () => {
        const wrapper = buildPrintableClone();
        await waitForImages(wrapper);
        // Cadena segura: toPdf().get('pdf').then(pdf => pdf.output('blob'))
        const worker = window.html2pdf().set(html2pdfOpts).from(wrapper).toPdf();
        const pdf = await worker.get('pdf');
        const blob = pdf.output('blob');
        return blob;
      };

      window.downloadPDF = async () => {
        try {
          const blob = await generatePdfBlob();
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = window.__pdfFilename;
          document.body.appendChild(a);
          a.click();
          setTimeout(()=> { URL.revokeObjectURL(a.href); a.remove(); }, 0);
        } catch(e) {
          console.error(e);
          alert('No fue posible generar el PDF.');
        }
      };

      window.sharePDFByEmail = async () => {
        try {
          const blob = await generatePdfBlob();
          const file = new File([blob], window.__pdfFilename, { type: 'application/pdf' });

          if (navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({
              title: 'Cotización - Talleres Barrera',
              text: 'Adjunto PDF de la cotización.',
              files: [file]
            });
          } else {
            // Fallback: descarga + mailto
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = window.__pdfFilename;
            document.body.appendChild(a);
            a.click();
            setTimeout(()=> {
              URL.revokeObjectURL(url);
              a.remove();
              const subject = encodeURIComponent('Cotización de Remolque - Talleres Barrera');
              const body = encodeURIComponent('Adjunto la cotización en PDF. Si no se adjuntó automáticamente, por favor inserte el archivo descargado.');
              window.location.href = `mailto:?subject=${subject}&body=${body}`;
            }, 250);
          }
        } catch(e) {
          console.error(e);
          alert('No fue posible preparar el correo con el PDF.');
        }
      };
    });

    // (Opcional) Enviar correo simple sin adjunto (se deja por compatibilidad)
    function sendEmail() {
      const subject = encodeURIComponent('Cotización de Remolque - Talleres Barrera');
      const body = encodeURIComponent(`Estimado cliente,\n\nAdjunto encontrará la cotización detallada para la fabricación de su remolque con Talleres Barrera S.A. de C.V.\n\nGracias por su preferencia.\n\nSaludos cordiales,\nEquipo de Ventas de Talleres Barrera S.A. de C.V.`);
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    }
  </script>
</body>
</html>
