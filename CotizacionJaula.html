<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cotización - Talleres Barrera</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link rel="stylesheet" href="https://ramcxn.github.io/Modificacion/cotizacion.css"/>

  <style>
    /* 1. Contenedor principal de especificaciones */
    #especificaciones-container {
      display: flex;              /* Activa el modo Flexbox */
      flex-wrap: wrap;            /* Permite que los elementos se muevan a la siguiente línea */
      justify-content: space-between; /* Crea espacio entre las columnas */
      page-break-inside: avoid;   /* Intenta mantener todo el bloque en una página */
    }

    /* 2. Cada sección dentro del contenedor */
    #especificaciones-container > .section {
      width: 48%;                 /* Cada sección ocupa un poco menos de la mitad del espacio */
      break-inside: avoid;        /* Evita que una sección se parta en un salto de página */
    }

    /* 3. Estilos de las imágenes de referencia (se mantienen igual) */
    .image-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: flex-start;
    }
    .reference-image {
      max-width: 220px;
      max-height: 180px;
      width: auto;
      height: auto;
      object-fit: contain;
      border: 1px solid #e5e7eb;
      padding: 4px;
      border-radius: 6px;
      background: #fff;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="actions-bar">
      <button class="action-button" onclick="window.print()"><i class="fas fa-print"></i> Imprimir</button>
      <button id="btnPdf" class="action-button" onclick="downloadPDF()"><i class="fas fa-file-pdf"></i> Descargar PDF</button>
      <button id="btnMail" class="action-button" onclick="emailWithPdf()"><i class="fas fa-envelope"></i> Enviar por correo</button>
    </div>
    <div class="header">
      <div class="header-info">
        <h1>COTIZACIÓN</h1>
        <h2>TALLERES BARRERA S.A. DE C.V.</h2>
        <p><strong>Dirección:</strong> Industria Automotriz #126, Col. Parque Industrial, CP 67735, Linares N.L. México</p>
        <p><strong>Teléfono:</strong> <span id="telefonoContacto"></span></p>
        <p><strong>Correo:</strong> <span id="correoContacto"></span></p>
        <p><strong>RFC:</strong> TBA7504018B4</p>
      </div>
      <img id="logoPrincipal"
           src="https://raw.githubusercontent.com/ramcxn/Modificacion/main/LOGO%20TB2025.png"
           alt="Logo de Talleres Barrera"
           class="logo"
           style="width: 50%; height: auto;" 
           crossorigin="anonymous"
           referrerpolicy="no-referrer">
    </div>
    <p>Por medio de la presente, <strong>TALLERES BARRERA S.A. DE C.V.</strong> agradece su interés en nuestros productos. A continuación, se presenta la cotización detallada para la fabricación de su remolque, incluyendo especificaciones, costos y términos de pago.</p>
    <div class="section">
      <h3 class="section-title">Información del Cliente y General</h3>
      <table class="info-table">
        <tr><td>Fecha de Cotización:</td><td><span id="fechaCotizacion"></span></td></tr>
        <tr><td>Cliente:</td><td><span id="cliente"></span></td></tr>
        <tr><td>Dirección del Cliente:</td><td><span id="direccionCliente"></span></td></tr>
        <tr><td>RFC del Cliente:</td><td><span id="rfcCliente"></span></td></tr>
        <tr><td>Tipo de Unidad:</td><td><span id="tipoUnidad"></span></td></tr>
        <tr><td>Realizado por (Vendedor):</td><td><span id="realizadoPor"></span></td></tr>
      </table>
    </div>

    <div id="especificaciones-container">
      <div class="section">
        <h3 class="section-title">Especificaciones Generales</h3>
        <table class="info-table">
          <tr><td>Color Primario:</td><td><span id="colorPrimario"></span></td></tr>
          <tr><td>Color Secundario:</td><td><span id="colorSecundario"></span></td></tr>
          <tr><td>Suspensión:</td><td><span id="suspension"></span> (<span id="cantSuspensiones"></span> piezas)</td></tr>
          <tr><td>Retráctil de Eje:</td><td><span id="retractilEje"></span></td></tr>
          <tr><td>Ejes:</td><td><span id="ejes"></span></td></tr>
          <tr><td>Distancia entre Ejes:</td><td><span id="distanciaEjes"></span></td></tr>
          <tr><td>Personalización de Viga:</td><td><span id="personalizacionViga"></span></td></tr>
          <tr><td>Faldón:</td><td><span id="faldon"></span></td></tr>
          <tr><td>Perno Rey:</td><td><span id="pernoRey"></span></td></tr>
          <tr><td>Portallantas:</td><td><span id="portallantas"></span></td></tr>
        </table>
      </div>
      <div class="section">
        <h3 class="section-title">Carrocería y Estructura</h3>
        <table class="info-table">
          <tr><td>Dimensiones:</td><td><span id="dimensiones"></span></td></tr>
          <tr><td>Tipo de Redila:</td><td><span id="tipoRedila"></span></td></tr>
          <tr><td>Secciones:</td><td><span id="secciones"></span></td></tr>
          <tr><td>Puertas Laterales:</td><td><span id="puertasLaterales"></span></td></tr>
          <tr><td>Compuerta al Piso:</td><td><span id="compAlPiso"></span></td></tr>
          <tr><td>Compuerta Trasera:</td><td><span id="compAtras"></span></td></tr>
          <tr><td>Tipo de Arco:</td><td><span id="tipoArco"></span></td></tr>
          <tr><td>Piso de Madera:</td><td><span id="pisoMadera"></span></td></tr>
          <tr><td>Piso Laminado:</td><td><span id="pisoLaminado"></span></td></tr>
          <tr><td>Caballete:</td><td><span id="caballete"></span></td></tr>
          <tr><td>Tubos Interiores:</td><td><span id="tubosInteriores"></span></td></tr>
          <tr><td>Barrote Lateral:</td><td><span id="barroteLateral"></span></td></tr>
          <tr><td>Compuerta a los Lados:</td><td><span id="compuertaLados"></span></td></tr>
          <tr><td>Cerrojo de Puertas Traseras:</td><td><span id="cerrojoPuertas"></span></td></tr>
          <tr><td>Sistema de Lona:</td><td><span id="sistemaLona"></span></td></tr>
          <tr><td>Luz de Placa:</td><td><span id="luzPlaca"></span></td></tr>
        </table>
      </div>
      <div class="section">
        <h3 class="section-title">Accesorios</h3>
        <table class="info-table">
          <tr><td>Rines:</td><td><span id="rines"></span> (<span id="cantRines"></span> piezas)</td></tr>
          <tr><td>Llantas:</td><td><span id="llantas"></span> (<span id="cantLlantas"></span> piezas)</td></tr>
          <tr><td>Frenos:</td><td><span id="frenos"></span></td></tr>
          <tr><td>Juego de Patines:</td><td><span id="juegoPatines"></span> (<span id="cantPatines"></span> piezas)</td></tr>
          <tr><td>Caja de Herramientas:</td><td><span id="cajaHerramientas"></span></td></tr>
          <tr><td>Lodera Delantera:</td><td><span id="loderaDelantera"></span></td></tr>
          <tr><td>Lodera Trasera:</td><td><span id="loderaTrasera"></span></td></tr>
          <tr><td>Manivelas de Patín:</td><td><span id="manivelasPatin"></span></td></tr>
          <tr><td>Direccionales:</td><td><span id="direccionales"></span></td></tr>
          <tr><td>Plafones:</td><td><span id="plafones"></span></td></tr>
        </table>
      </div>
    </div>

    <div class="section">
      <h3 class="section-title">Imágenes de Referencia</h3>
      <div class="image-container" id="imagenes-container"></div>
    </div>
    <div class="section">
      <h3 class="section-title">Observaciones y modificaciones a la unidad</h3>
      <ul class="notes-list">
        <li><strong>Observaciones de Pintura:</strong> <span id="observacionesPintura"></span></li>
        <li><strong>Observaciones Generales:</strong> <span id="observacionesGenerales"></span></li>
      </ul>
    </div>
    <div class="section">
      <h3 class="section-title">Resumen de Costos y Términos de Pago</h3>
      <div class="vendor-only" style="margin-bottom:8px;">
        <label><strong>Ajuste de precio manual:</strong></label>
        <input type="number" id="ajusteManual" step="0.01" placeholder="0.00" />
        <span class="hint">Use valores positivos (+) o negativos (−).</span>
      </div>
      <table class="cost-table">
        <thead><tr><th>Concepto</th><th>Monto</th></tr></thead>
        <tbody>
          <tr><td>Costo Total de la Unidad:</td><td><span id="costoTotal"></span></td></tr>
          <tr><td>Depósito para Inicio de Fabricación (50%):</td><td><span id="deposito"></span></td></tr>
          <tr><td>Saldo a Liquidar a la Entrega (50%):</td><td><span id="saldo"></span></td></tr>
          <tr class="total-row"><td>TOTAL:</td><td><strong><span id="totalFinal"></span></strong></td></tr>
        </tbody>
      </table>
      <div class="bank-info">
        <p><strong>Datos Bancarios para Depósito:</strong></p>
        <p><strong>Titular:</strong> TALLERES BARRERA S.A. DE C.V.</p>
        <table class="bank-table">
          <thead><tr><th>Banco</th><th>Sucursal</th><th>Cuenta</th><th>CLABE</th></tr></thead>
          <tbody>
            <tr><td>SANTANDER</td><td>3945</td><td>65500883468</td><td>014 595 65500883468 7</td></tr>
            <tr><td>BBVA</td><td>1729</td><td>00450461113</td><td>012 580 00450461113 7</td></tr>
            <tr><td>CITIBANAMEX</td><td>0796</td><td>07966989054</td><td>002 595 07966989054 8</td></tr>
            <tr><td>BANORTE</td><td>060</td><td>00060251843</td><td>072 595 00060251843 3</td></tr>
          </tbody>
        </table>
        <p>Favor de enviar su notificación de depósito a <strong>contabilidad@talleresbarrera.com</strong> y <strong>barrera@talleresbarrera.com</strong>.</p>
      </div>
      <p><strong>Consideraciones:</strong></p>
      <ul class="notes-list">
        <li>El depósito inicial no es reembolsable.</li>
        <li>El precio final puede ajustarse en caso de que se soliciten modificaciones adicionales no contempladas en esta cotización.</li>
        <li>El tiempo de entrega estimado es de 6 a 8 semanas, a partir de la confirmación del depósito inicial.</li>
        <li>A partir de la fecha de entrega emitida, se tendrá un tiempo de almacén de 15 días naturales. Después, $1,000 MXN por semana.</li>
      </ul>
    </div>
    <div class="section">
      <h3 class="section-title">Aprobación del Cliente</h3>
      <p>Con la firma de este documento, usted confirma que ha revisado y aprobado las especificaciones y los costos detallados en esta cotización. Esta firma autoriza a TALLERES BARRERA S.A. DE C.V. a iniciar el proceso de fabricación de la unidad.</p>
      <div class="firma-section">
        <div class="firma-line"></div>
        <p>Firma de Aprobación</p>
      </div>
    </div>
    <div class="footer-logo-container">
      <img src="https://raw.githubusercontent.com/ramcxn/Modificacion/main/CER%20COMPANY%20-%20ISO%209001.png" alt="Empresa Certificada ISO 9001:2015" class="iso-logo">
    </div>
  </div>
  <script>
    // El JavaScript no necesita cambios.
    const urlParams = new URLSearchParams(window.location.search);
    const getParam = (name) => {
      const raw = urlParams.get(name);
      if (raw === null || raw === undefined) return '';
      try { return decodeURIComponent(String(raw).replace(/\+/g, ' ')); }
      catch { return raw; }
    };
    const getParamRaw = (name) => urlParams.get(name) || '';
    const appName = "NewApp-1254688";
    const tableName = "Modificaciones";
    function getAppSheetImageUrl(fileNameRaw) {
      if (!fileNameRaw) return '';
      return `https://www.appsheet.com/template/gettablefileurl?appName=${encodeURIComponent(appName)}&tableName=${encodeURIComponent(tableName)}&fileName=${fileNameRaw}&_=${Date.now()}`;
    }
    const money = (v) => {
      const n = Number(v);
      if (!isFinite(n)) return '$0.00';
      return n.toLocaleString('es-MX', { style: 'currency', currency: 'MXN' });
    };
    const safe = (s) => (s || '').toString().replace(/[^a-z0-9-_]+/gi, '_').slice(0, 60);
    const today = new Date();
    window.__pdfFilename = `Cotizacion_${safe(getParam('cliente'))}_${today.toISOString().slice(0, 10)}.pdf`;
    function fillData() {
      document.getElementById('fechaCotizacion').innerText = today.toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' });
      const fields = {
        'telefonoContacto': 'telefono_contacto', 'correoContacto': 'correo_contacto', 'cliente': 'cliente',
        'direccionCliente': 'direccion', 'rfcCliente': 'rfc', 'tipoUnidad': 'tipo_de_unidad',
        'realizadoPor': 'realizado_por', 'colorPrimario': 'color', 'colorSecundario': 'color_2',
        'suspension': 'suspension', 'cantSuspensiones': 'cantidad_de_suspensiones', 'retractilEje': 'retractil_eje',
        'ejes': 'ejes', 'distanciaEjes': 'distancia_de_ejes', 'personalizacionViga': 'personalizacion_de_viga',
        'faldon': 'faldon', 'pernoRey': 'perno_rey', 'portallantas': 'portallantas', 'dimensiones': 'dimensiones',
        'tipoRedila': 'tipo_de_redila', 'secciones': 'secciones', 'puertasLaterales': 'puertas_laterales',
        'compAlPiso': 'comp_al_piso', 'compAtras': 'comp_atras', 'tipoArco': 'tipo_de_arco',
        'pisoMadera': 'piso_de_madera', 'pisoLaminado': 'piso_laminado', 'caballete': 'caballete',
        'tubosInteriores': 'tubos_interiores', 'barroteLateral': 'barrote_lateral', 'compuertaLados': 'compuerta_a_los_lados',
        'cerrojoPuertas': 'cerrojo_de_puertas_traseras', 'sistemaLona': 'sistema_de_lona',
        'rines': 'rines', 'cantRines': 'cantidad_de_rines', 'llantas': 'llantas_70', 'cantLlantas': 'cantidad_de_llantas',
        'frenos': 'frenos', 'juegoPatines': 'juego_de_patines', 'cantPatines': 'cantidad_de_patines',
        'cajaHerramientas': 'caja_de_herramientas', 'loderaDelantera': 'lodera_delantera', 'loderaTrasera': 'lodera_trasera',
        'manivelasPatin': 'manivelas_de_patin', 'direccionales': 'direccionales', 'plafones': 'plafones',
        'observacionesPintura': ['observaciones_de_pintura', 'OBSERVACIONES_DE_PINTURA'],
        'observacionesGenerales': ['observaciones', 'OBSERVACIONES']
      };
      for (const id in fields) {
        const paramNames = Array.isArray(fields[id]) ? fields[id] : [fields[id]];
        for (const name of paramNames) {
          const value = getParam(name);
          if (value) {
            document.getElementById(id).innerText = value;
            break;
          }
        }
      }
      const luzPlacaValue = getParam('luz_placa');
      document.getElementById('luzPlaca').innerText = (luzPlacaValue.toUpperCase() === 'Y') ? 'Si' : 'No';
      const costoBase = parseFloat(urlParams.get('Costo_de_la_Unidad') || '0') || 0;
      setCosts(costoBase);
      document.getElementById('ajusteManual').addEventListener('input', (e) => {
        const ajuste = parseFloat(e.target.value || '0') || 0;
        setCosts(costoBase + ajuste);
      });
      loadImages();
    }
    function setCosts(total) {
      const deposito = total * 0.5;
      const saldo = total - deposito;
      document.getElementById('costoTotal').innerText = money(total);
      document.getElementById('deposito').innerText = money(deposito);
      document.getElementById('saldo').innerText = money(saldo);
      document.getElementById('totalFinal').innerText = money(total);
    }
    function loadImages() {
      const container = document.getElementById('imagenes-container');
      const keys = ['imagen_de_referencia', 'imagen_de_referencia_81', 'imagen_de_referencia_82', 'imagen_de_referencia_83', 'imagen_de_referencia_84', 'imagen_de_referencia_85'];
      let hasImages = false;
      keys.forEach(key => {
        const fileRaw = getParamRaw(key);
        if (fileRaw) {
          hasImages = true;
          const img = new Image();
          img.className = 'reference-image';
          img.alt = 'Imagen de referencia';
          img.crossOrigin = 'anonymous';
          img.referrerPolicy = 'no-referrer';
          img.src = getAppSheetImageUrl(fileRaw);
          img.onerror = () => {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'img-error';
            errorDiv.innerHTML = `No se pudo cargar la imagen: <a href="${img.src}" target="_blank">ver enlace</a>`;
            container.appendChild(errorDiv);
          };
          container.appendChild(img);
        }
      });
      if (!hasImages) {
        container.innerHTML = '<p>No se han proporcionado imágenes de referencia.</p>';
      }
    }
    function loadHtml2Pdf(callback) {
      if (window.html2pdf) { callback && callback(); return; }
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
      script.onload = () => callback && callback();
      script.onerror = () => alert('No fue posible cargar el generador de PDF.');
      document.head.appendChild(script);
    }
    function toggleUiForPdf(hide) {
      document.querySelectorAll('.actions-bar, .vendor-only').forEach(el => {
        if (hide) {
          el.dataset.prevDisplay = el.style.display || '';
          el.style.display = 'none';
        } else {
          el.style.display = el.dataset.prevDisplay || '';
        }
      });
    }
    function downloadPDF() {
      loadHtml2Pdf(() => {
        toggleUiForPdf(true);
        const element = document.querySelector('.container');
        const opt = {
          margin: [10, 10, 10, 10],
          filename: window.__pdfFilename || 'Cotizacion.pdf',
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true, allowTaint: true, letterRendering: true },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        window.html2pdf().set(opt).from(element).save().finally(() => toggleUiForPdf(false));
      });
    }
    function makePdfBlob(callback) {
        loadHtml2Pdf(() => {
            toggleUiForPdf(true);
            const element = document.querySelector('.container');
            const opt = {
                margin: [10, 10, 10, 10],
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, allowTaint: true, letterRendering: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            window.html2pdf().set(opt).from(element).outputPdf('blob')
              .then(blob => {
                  toggleUiForPdf(false);
                  callback && callback(blob);
              }).catch(() => toggleUiForPdf(false));
        });
    }
    async function emailWithPdf() {
        makePdfBlob(async (blob) => {
            const filename = window.__pdfFilename || 'Cotizacion.pdf';
            const file = new File([blob], filename, { type: 'application/pdf' });
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({ files: [file], title: 'Cotización', text: 'Adjunto PDF de la cotización.' });
                    return;
                } catch (e) { console.warn("Share API cancelado."); }
            }
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            setTimeout(() => URL.revokeObjectURL(a.href), 2000);
            const subject = encodeURIComponent('Cotización de Remolque - Talleres Barrera');
            const body = encodeURIComponent('Estimado cliente,\n\nAdjunto encontrará la cotización en PDF (si no se adjuntó automáticamente, utilice el archivo descargado).\n\nSaludos,\nEquipo de Ventas');
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        });
    }
    document.addEventListener('DOMContentLoaded', fillData);
  </script>
</body>
</html>
