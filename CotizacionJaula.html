<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cotización - Talleres Barrera</title>

  <!-- Iconos y estilos base -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <link rel="stylesheet" href="https://ramcxn.github.io/Modificacion/cotizacion.css"/>

  <style>
    /* Ajustes de impresión y ocultar controles en PDF/impresión */
    @media print {
      body { font-size: 10px; }
      .section, .header { padding: 10px; margin-bottom: 5px; }
      .actions-bar { display: none !important; }
      .info-table td, .cost-table th, .cost-table td { padding: 3px; }
      .logo { width: 100px; }
      /* Oculta elementos sólo para vendedor */
      .vendor-only { display: none !important; }
      /* Oculta el renglón de ajuste para el cliente */
      #rowAjuste { display: none !important; }
    }

    /* Asegurar que imágenes (logo) se impriman */
    img { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    #logoPrincipal { display: block; }

    /* Botones / barra de acciones en pantalla */
    .actions-bar {
      display: flex;
      gap: .5rem;
      justify-content: flex-end;
      margin-bottom: 12px;
    }
    .action-button {
      background:#1f2937; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;
    }
    .action-button i { margin-right:6px; }
    .action-button:disabled { opacity: .6; cursor: not-allowed; }

    /* Campo de ajuste */
    .adjust-wrap {
      display: flex; align-items: center; gap: 8px;
    }
    .adjust-wrap input {
      max-width: 160px; padding:6px 8px; border:1px solid #d1d5db; border-radius:6px;
    }

    /* Imágenes de referencia */
    .image-container { display:flex; flex-wrap:wrap; gap:10px; align-items:flex-start }
    .reference-image { max-width: 220px; max-height: 180px; object-fit: contain; border:1px solid #e5e7eb; padding:4px; border-radius:6px; background:#fff; }

    /* Pie de página logos */
    .footer-logo-container { display:flex; justify-content:center; margin-top: 16px; }
    .iso-logo { max-height: 50px; }

    /* Etiqueta pequeña de ayuda */
    .hint { color:#6b7280; font-size: 12px; }
  </style>
</head>

<body>
  <div class="container">
    <!-- Botones (ocultos al imprimir / PDF) -->
    <div class="actions-bar no-pdf">
      <button class="action-button" onclick="window.print()">
        <i class="fas fa-print"></i> Imprimir
      </button>
      <button id="btnPdf" class="action-button" onclick="downloadPDF()">
        <i class="fas fa-file-pdf"></i> Descargar PDF
      </button>
      <button id="btnMail" class="action-button" onclick="emailWithPdf()">
        <i class="fas fa-envelope"></i> Enviar por correo
      </button>
    </div>

    <!-- Encabezado -->
    <div class="header">
      <div class="header-info">
        <h1>COTIZACIÓN</h1>
        <h2>TALLERES BARRERA S.A. DE C.V.</h2>
        <p><strong>Dirección:</strong> Industria Automotriz #126, Col. Parque Industrial, CP 67735, Linares N.L. México</p>
        <p><strong>Teléfono:</strong> <span id="telefonoContacto"></span></p>
        <p><strong>Correo:</strong> <span id="correoContacto"></span></p>
        <p><strong>RFC:</strong> TBA7504018B4</p>
      </div>
      <img id="logoPrincipal" src="https://www.appsheet.com:443/fsimage.png?appid=15ab7ef8-4923-40f5-80ca-3607e9850805&datasource=google&filename=DocId%3D1ON0AOw6aLouPB4hLD4HSPHQrMyYHFX5x&signature=47171ea295d0c06dc250337a646296a67b31c22191c59f9869bf63a365b8ae49&tableprovider=google&userid=1254688" alt="Logo de Talleres Barrera" class="logo" />
    </div>

    <p>Por medio de la presente, <strong>TALLERES BARRERA S.A. DE C.V.</strong> agradece su interés en nuestros productos. A continuación, se presenta la cotización detallada para la fabricación de su remolque, incluyendo especificaciones, costos y términos de pago.</p>

    <!-- Información del Cliente -->
    <div class="section">
      <h3 class="section-title">Información del Cliente y General</h3>
      <table class="info-table">
        <tr><td>Fecha de Cotización:</td><td><span id="fechaCotizacion"></span></td></tr>
        <tr><td>Cliente:</td><td><span id="cliente"></span></td></tr>
        <tr><td>Dirección del Cliente:</td><td><span id="direccionCliente"></span></td></tr>
        <tr><td>RFC del Cliente:</td><td><span id="rfcCliente"></span></td></tr>
        <tr><td>Tipo de Unidad:</td><td><span id="tipoUnidad"></span></td></tr>
        <tr><td>Realizado por (Vendedor):</td><td><span id="realizadoPor"></span></td></tr>
      </table>
    </div>

    <!-- Especificaciones Generales -->
    <div class="section">
      <h3 class="section-title">Especificaciones Generales</h3>
      <table class="info-table">
        <tr><td>Color Primario:</td><td><span id="colorPrimario"></span></td></tr>
        <tr><td>Color Secundario:</td><td><span id="colorSecundario"></span></td></tr>
        <tr><td>Suspensión:</td><td><span id="suspension"></span> (<span id="cantSuspensiones"></span> piezas)</td></tr>
        <tr><td>Retráctil de Eje:</td><td><span id="retractilEje"></span></td></tr>
        <tr><td>Ejes:</td><td><span id="ejes"></span></td></tr>
        <tr><td>Distancia entre Ejes:</td><td><span id="distanciaEjes"></span></td></tr>
        <tr><td>Personalización de Viga:</td><td><span id="personalizacionViga"></span></td></tr>
        <tr><td>Faldón:</td><td><span id="faldon"></span></td></tr>
        <tr><td>Perno Rey:</td><td><span id="pernoRey"></span></td></tr>
        <tr><td>Portallantas:</td><td><span id="portallantas"></span></td></tr>
      </table>
    </div>

    <!-- Carrocería y Estructura -->
    <div class="section">
      <h3 class="section-title">Carrocería y Estructura</h3>
      <table class="info-table">
        <tr><td>Dimensiones:</td><td><span id="dimensiones"></span></td></tr>
        <tr><td>Tipo de Redila:</td><td><span id="tipoRedila"></span></td></tr>
        <tr><td>Secciones:</td><td><span id="secciones"></span></td></tr>
        <tr><td>Puertas Laterales:</td><td><span id="puertasLaterales"></span></td></tr>
        <tr><td>Compuerta al Piso:</td><td><span id="compAlPiso"></span></td></tr>
        <tr><td>Compuerta Trasera:</td><td><span id="compAtras"></span></td></tr>
        <tr><td>Tipo de Arco:</td><td><span id="tipoArco"></span></td></tr>
        <tr><td>Piso de Madera:</td><td><span id="pisoMadera"></span></td></tr>
        <tr><td>Piso Laminado:</td><td><span id="pisoLaminado"></span></td></tr>
        <tr><td>Caballete:</td><td><span id="caballete"></span></td></tr>
        <tr><td>Tubos Interiores:</td><td><span id="tubosInteriores"></span></td></tr>
        <tr><td>Barrote Lateral:</td><td><span id="barroteLateral"></span></td></tr>
        <tr><td>Compuerta a los Lados:</td><td><span id="compuertaLados"></span></td></tr>
        <tr><td>Cerrojo de Puertas Traseras:</td><td><span id="cerrojoPuertas"></span></td></tr>
        <tr><td>Sistema de Lona:</td><td><span id="sistemaLona"></span></td></tr>
        <tr><td>Luz de Placa:</td><td><span id="luzPlaca"></span></td></tr>
      </table>
    </div>

    <!-- Accesorios -->
    <div class="section">
      <h3 class="section-title">Accesorios</h3>
      <table class="info-table">
        <tr><td>Rines:</td><td><span id="rines"></span> (<span id="cantRines"></span> piezas)</td></tr>
        <tr><td>Llantas:</td><td><span id="llantas"></span> (<span id="cantLlantas"></span> piezas)</td></tr>
        <tr><td>Frenos:</td><td><span id="frenos"></span></td></tr>
        <tr><td>Juego de Patines:</td><td><span id="juegoPatines"></span> (<span id="cantPatines"></span> piezas)</td></tr>
        <tr><td>Caja de Herramientas:</td><td><span id="cajaHerramientas"></span></td></tr>
        <tr><td>Lodera Delantera:</td><td><span id="loderaDelantera"></span></td></tr>
        <tr><td>Lodera Trasera:</td><td><span id="loderaTrasera"></span></td></tr>
        <tr><td>Manivelas de Patín:</td><td><span id="manivelasPatin"></span></td></tr>
        <tr><td>Direccionales:</td><td><span id="direccionales"></span></td></tr>
        <tr><td>Plafones:</td><td><span id="plafones"></span></td></tr>
      </table>
    </div>

    <!-- Imágenes -->
    <div class="section">
      <h3 class="section-title">Imágenes de Referencia</h3>
      <div class="image-container" id="imagenes-container"></div>
    </div>

    <!-- Observaciones -->
    <div class="section">
      <h3 class="section-title">Observaciones y modificaciones a la unidad</h3>
      <ul class="notes-list">
        <li><strong>Observaciones de Pintura:</strong> <span id="observacionesPintura"></span></li>
        <li><strong>Observaciones Generales:</strong> <span id="observacionesGenerales"></span></li>
      </ul>
    </div>

    <!-- Costos -->
    <div class="section">
      <h3 class="section-title">Resumen de Costos y Términos de Pago</h3>

      <!-- Controles para vendedor (no salen en PDF/impresión) -->
      <div class="vendor-only" style="margin-bottom:8px;">
        <div class="adjust-wrap">
          <label for="ajusteManual"><strong>Ajuste de precio manual:</strong></label>
          <input type="number" id="ajusteManual" step="0.01" placeholder="0.00" />
          <span class="hint">Usa valores positivos (+) o negativos (−). Se aplican al TOTAL mostrado.</span>
        </div>
      </div>

      <table class="cost-table">
        <thead>
          <tr><th>Concepto</th><th>Monto</th></tr>
        </thead>
        <tbody>
          <tr><td>Costo Total de la Unidad:</td><td><span id="costoTotal"></span></td></tr>
          <tr><td>Depósito para Inicio de Fabricación (50%):</td><td><span id="deposito"></span></td></tr>
          <tr><td>Saldo a Liquidar a la Entrega (50%):</td><td><span id="saldo"></span></td></tr>
          <tr id="rowAjuste"><td>Ajuste de precio manual:</td><td><span id="ajusteSpan"></span></td></tr>
          <tr class="total-row"><td>TOTAL:</td><td><strong><span id="totalFinal"></span></strong></td></tr>
        </tbody>
      </table>

      <div class="bank-info">
        <p><strong>Datos Bancarios para Depósito:</strong></p>
        <p><strong>Titular:</strong> TALLERES BARRERA S.A. DE C.V.</p>
        <table class="bank-table">
          <thead>
            <tr><th>Banco</th><th>Sucursal</th><th>Cuenta</th><th>CLABE</th></tr>
          </thead>
          <tbody>
            <tr><td>SANTANDER</td><td>3945</td><td>65500883468</td><td>014 595 65500883468 7</td></tr>
            <tr><td>BBVA</td><td>1729</td><td>00450461113</td><td>012 580 00450461113 7</td></tr>
            <tr><td>CITIBANAMEX</td><td>0796</td><td>07966989054</td><td>002 595 07966989054 8</td></tr>
            <tr><td>BANORTE</td><td>060</td><td>00060251843</td><td>072 595 00060251843 3</td></tr>
          </tbody>
        </table>
        <p>Favor de enviar su notificación de depósito a los siguientes correos: <strong>contabilidad@talleresbarrera.com</strong> y <strong>barrera@talleresbarrera.com</strong>.</p>
      </div>

      <p><strong>Consideraciones:</strong></p>
      <ul class="notes-list">
        <li>El depósito inicial no es reembolsable.</li>
        <li>El precio final puede ajustarse en caso de que se soliciten modificaciones adicionales no contempladas en esta cotización.</li>
        <li>El tiempo de entrega estimado es de 6 a 8 semanas, a partir de la confirmación del depósito inicial.</li>
        <li>A partir de la fecha de entrega emitida, se tendrá un tiempo de almacén de 15 días naturales. A partir de este tiempo, se generará un costo por almacenamiento de la unidad de $1,000 pesos por semana.</li>
      </ul>
    </div>

    <!-- Firma -->
    <div class="section">
      <h3 class="section-title">Aprobación del Cliente</h3>
      <p>Con la firma de este documento, usted confirma que ha revisado y aprobado las especificaciones y los costos detallados en esta cotización. Esta firma autoriza a TALLERES BARRERA S.A. DE C.V. a iniciar el proceso de fabricación de la unidad.</p>
      <div class="firma-section">
        <div class="firma-line"></div>
        <p>Firma de Aprobación</p>
      </div>
    </div>

    <!-- Logo ISO -->
    <div class="footer-logo-container">
      <img src="https://raw.githubusercontent.com/ramcxn/Modificacion/main/CER%20COMPANY%20-%20ISO%209001.png" alt="Empresa Certificada ISO 9001:2015" class="iso-logo">
    </div>
  </div>

  <script>
    // --- UTILIDADES ---
    const urlParams = new URLSearchParams(window.location.search);

    // Para textos mostrados (decodifica para legibilidad)
    const getParam = (name) => {
      const raw = urlParams.get(name);
      if (raw === null || raw === undefined) return '';
      try { return decodeURIComponent(String(raw).replace(/\+/g,' ')); }
      catch { return raw; }
    };

    // Para archivos (NO decodificar; se re-codifica => doble-encoding, como tu HTML que sí funcionaba)
    const getParamRaw = (name) => urlParams.get(name) || '';

    const appName = "NewApp-1254688";
    const getAppSheetImageUrl = (fileNameRaw) => {
      if (!fileNameRaw) return '';
      // NO decodeURIComponent -> volvemos a codificar lo que ya viene codificado
      const fileNameDoubleEncoded = encodeURIComponent(fileNameRaw);
      return `https://www.appsheet.com/template/gettablefileurl` +
             `?appName=${encodeURIComponent(appName)}` +
             `&tableName=${encodeURIComponent('Modificaciones')}` +
             `&fileName=${fileNameDoubleEncoded}`;
    };

    const money = (v) => {
      const n = Number(v);
      if (!isFinite(n)) return '$0.00 MXN';
      return n.toLocaleString('es-MX', { style:'currency', currency:'MXN' });
    };

    // Sugerir nombre de archivo
    const safe = (s) => (s||'').toString().replace(/[^a-z0-9-_]+/gi,'_').slice(0,60);
    const todayStr = new Date().toISOString().slice(0,10);
    window.__pdfFilename = `Cotizacion_${safe(getParam('cliente'))}_${todayStr}.pdf`;

    // --- CARGA DE DATOS ---
    function fillData(){
      // Fecha
      document.getElementById('fechaCotizacion').innerText =
        new Date().toLocaleDateString('es-MX', { year:'numeric', month:'long', day:'numeric' });

      // Contacto del vendedor (si lo mandas en la URL)
      document.getElementById('telefonoContacto').innerText = getParam('telefono_contacto');
      document.getElementById('correoContacto').innerText   = getParam('correo_contacto');

      // Cliente
      document.getElementById('cliente').innerText          = getParam('cliente');
      document.getElementById('direccionCliente').innerText = getParam('direccion');
      document.getElementById('rfcCliente').innerText       = getParam('rfc');
      document.getElementById('tipoUnidad').innerText       = getParam('tipo_de_unidad');
      document.getElementById('realizadoPor').innerText     = getParam('realizado_por');

      // Generales
      document.getElementById('colorPrimario').innerText        = getParam('color');
      document.getElementById('colorSecundario').innerText      = getParam('color_2');
      document.getElementById('suspension').innerText           = getParam('suspension');
      document.getElementById('cantSuspensiones').innerText     = getParam('cantidad_de_suspensiones');
      document.getElementById('retractilEje').innerText         = getParam('retractil_eje');
      document.getElementById('ejes').innerText                 = getParam('ejes');
      document.getElementById('distanciaEjes').innerText        = getParam('distancia_de_ejes');
      document.getElementById('personalizacionViga').innerText  = getParam('personalizacion_de_viga');
      document.getElementById('faldon').innerText               = getParam('faldon');
      document.getElementById('pernoRey').innerText             = getParam('perno_rey');
      document.getElementById('portallantas').innerText         = getParam('portallantas');

      // Carrocería
      document.getElementById('dimensiones').innerText      = getParam('dimensiones');
      document.getElementById('tipoRedila').innerText       = getParam('tipo_de_redila');
      document.getElementById('secciones').innerText        = getParam('secciones');
      document.getElementById('puertasLaterales').innerText = getParam('puertas_laterales');
      document.getElementById('compAlPiso').innerText       = getParam('comp_al_piso');
      document.getElementById('compAtras').innerText        = getParam('comp_atras');
      document.getElementById('tipoArco').innerText         = getParam('tipo_de_arco');
      document.getElementById('pisoMadera').innerText       = getParam('piso_de_madera');
      document.getElementById('pisoLaminado').innerText     = getParam('piso_laminado');
      document.getElementById('caballete').innerText        = getParam('caballete');
      document.getElementById('tubosInteriores').innerText  = getParam('tubos_interiores');
      document.getElementById('barroteLateral').innerText   = getParam('barrote_lateral');
      document.getElementById('compuertaLados').innerText   = getParam('compuerta_a_los_lados');
      document.getElementById('cerrojoPuertas').innerText   = getParam('cerrojo_de_puertas_traseras');
      document.getElementById('sistemaLona').innerText      = getParam('sistema_de_lona');
      document.getElementById('luzPlaca').innerText         = getParam('luz_placa');

      // Accesorios
      document.getElementById('rines').innerText            = getParam('rines');
      document.getElementById('cantRines').innerText        = getParam('cantidad_de_rines');
      document.getElementById('llantas').innerText          = getParam('llantas_70');
      document.getElementById('cantLlantas').innerText      = getParam('cantidad_de_llantas');
      document.getElementById('frenos').innerText           = getParam('frenos');
      document.getElementById('juegoPatines').innerText     = getParam('juego_de_patines');
      document.getElementById('cantPatines').innerText      = getParam('cantidad_de_patines');
      document.getElementById('cajaHerramientas').innerText = getParam('caja_de_herramientas');
      document.getElementById('loderaDelantera').innerText  = getParam('lodera_delantera');
      document.getElementById('loderaTrasera').innerText    = getParam('lodera_trasera');
      document.getElementById('manivelasPatin').innerText   = getParam('manivelas_de_patin');
      document.getElementById('direccionales').innerText    = getParam('direccionales');
      document.getElementById('plafones').innerText         = getParam('plafones');

      // Observaciones
      document.getElementById('observacionesPintura').innerText   = getParam('observaciones_de_pintura') || getParam('OBSERVACIONES_DE_PINTURA');
      document.getElementById('observacionesGenerales').innerText = getParam('observaciones') || getParam('OBSERVACIONES');

      // Costos
      const costoRaw = urlParams.get('Costo_de_la_Unidad') || '0';
      const costo = parseFloat(costoRaw) || 0;
      const deposito = costo * 0.50;
      const saldo    = costo - deposito;

      document.getElementById('costoTotal').innerText = money(costo);
      document.getElementById('deposito').innerText   = money(deposito);
      document.getElementById('saldo').innerText      = money(saldo);

      // Ajuste manual
      const ajusteInput = document.getElementById('ajusteManual');
      const ajusteSpan  = document.getElementById('ajusteSpan');
      const totalFinal  = document.getElementById('totalFinal');

      const recompute = () => {
        const aj = parseFloat(ajusteInput.value || '0') || 0;
        ajusteSpan.textContent = (aj === 0 ? '$0.00 MXN' : money(aj));
        totalFinal.textContent = money(costo + aj);
      };
      ajusteInput.addEventListener('input', recompute);
      ajusteSpan.textContent = '$0.00 MXN';
      totalFinal.textContent = money(costo);

      // Imágenes (doble-encoding, tabla fija Modificaciones)
      const imagenesContainer = document.getElementById('imagenes-container');
      const imagenParams = [
        'imagen_de_referencia',
        'imagen_de_referencia_81',
        'imagen_de_referencia_82',
        'imagen_de_referencia_83',
        'imagen_de_referencia_84',
        'imagen_de_referencia_85'
      ];
      let hasImages = false;
      imagenParams.forEach(paramName => {
        const fileNameRaw = getParamRaw(paramName); // RAW
        if (!fileNameRaw) return;
        const src = getAppSheetImageUrl(fileNameRaw);
        const img = new Image();
        img.className = 'reference-image';
        img.alt = 'Imagen de referencia';
        img.crossOrigin = 'anonymous';
        img.onload  = () => { hasImages = true; };
        img.onerror = () => console.warn('No se pudo cargar imagen:', fileNameRaw, '=>', src);
        img.src = src;
        imagenesContainer.appendChild(img);
      });
      if (!hasImages) {
        imagenesContainer.innerHTML = '<p>No se han proporcionado imágenes de referencia.</p>';
      }
    }

    // --- PDF: html2pdf ---
    function loadHtml2Pdf(callback){
      if (window.html2pdf) { callback && callback(); return; }
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
      s.onload = () => callback && callback();
      s.onerror = () => alert('No fue posible cargar el generador de PDF. Intenta nuevamente.');
      document.head.appendChild(s);
    }

    function hideUIForPdf(hide = true){
      // Ocultar barra de acciones, secciones solo para vendedor y el renglón de ajuste
      const toToggle = document.querySelectorAll('.no-pdf, .vendor-only, #rowAjuste');
      toToggle.forEach(el => {
        if (hide) { el.dataset.prevDisplay = el.style.display || ''; el.style.display = 'none'; }
        else { el.style.display = el.dataset.prevDisplay || ''; delete el.dataset.prevDisplay; }
      });
    }

    function makePdfBlob(cb){
      loadHtml2Pdf(() => {
        hideUIForPdf(true);
        const element = document.querySelector('.container');
        const opt = {
          margin:       [10,10,10,10],
          filename:     window.__pdfFilename || 'Cotizacion.pdf',
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 2, useCORS: true, letterRendering: true, allowTaint: true },
          jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        try {
          // Generar Blob (no guardar aún)
          window.html2pdf().set(opt).from(element).outputPdf('blob').then((blob) => {
            hideUIForPdf(false);
            cb && cb(blob);
          }).catch(err => {
            console.error(err);
            hideUIForPdf(false);
            alert('No se pudo generar el PDF.');
          });
        } catch(e){
          console.error(e);
          hideUIForPdf(false);
          alert('No se pudo generar el PDF.');
        }
      });
    }

    function downloadPDF(){
      loadHtml2Pdf(() => {
        hideUIForPdf(true);
        const element = document.querySelector('.container');
        const opt = {
          margin:       [10,10,10,10],
          filename:     window.__pdfFilename || 'Cotizacion.pdf',
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 2, useCORS: true, letterRendering: true, allowTaint: true },
          jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        window.html2pdf().set(opt).from(element).save().then(() => {
          hideUIForPdf(false);
        }).catch(err => {
          console.error(err);
          hideUIForPdf(false);
          alert('No se pudo descargar el PDF.');
        });
      });
    }

    // Enviar por correo: intenta adjuntar (navegadores que soportan Web Share con archivos), si no, descarga y abre mailto
    function emailWithPdf(){
      makePdfBlob(async (blob) => {
        const filename = window.__pdfFilename || 'Cotizacion.pdf';
        const file = new File([blob], filename, { type: 'application/pdf' });

        // Web Share API Level 2 con archivos (móvil principalmente)
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          try {
            await navigator.share({
              files: [file],
              title: 'Cotización de Remolque - Talleres Barrera',
              text: 'Adjunto encontrará la cotización detallada de su remolque.'
            });
            return;
          } catch (e) {
            console.warn('Share cancelado o fallido:', e);
          }
        }

        // Fallback: descargar y abrir mailto (NO puede adjuntar por limitación del navegador)
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        setTimeout(() => URL.revokeObjectURL(a.href), 2000);

        const subject = encodeURIComponent('Cotización de Remolque - Talleres Barrera');
        const body = encodeURIComponent('Estimado cliente,\n\nAdjunto encontrará la cotización en PDF (si no se adjuntó automáticamente, por favor utilice el archivo descargado).\n\nSaludos cordiales,\nEquipo de Ventas de Talleres Barrera S.A. de C.V.');
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
      });
    }

    // Forzar logo visible incluso si falla carga (permite reemplazo por ?logo=)
    (function ensureLogo(){
      const logo = document.getElementById('logoPrincipal');
      const logoOverride = getParam('logo'); // opcional: ?logo=https://...
      if (logoOverride) logo.src = logoOverride;
      logo.onerror = () => {
        // intenta con override si existe
        if (logoOverride) return;
        console.warn('Logo principal no cargó.');
      };
    })();

    document.addEventListener('DOMContentLoaded', fillData);
  </script>
</body>
</html>
